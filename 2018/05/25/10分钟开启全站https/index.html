<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="peiqixin,peiqixin@gmail.com"><title>10分钟开启全站https · ToPeas-技术博客</title><meta name="description" content="持续了1个多月的备案，今天收到短信终于下来了。
上篇水文，大概的记录了作为前端利用gitlab.com利用gitlab-ci开启CI自动部署。前端的gitlab的ci初尝试。这篇文章就要开始记录下我如何开启https。
什么是https？https 是什么，不是本文的重点，直接跳过，https 的好"><meta name="keywords" content="node,vue,front-end,full-stack,"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="https://www.googletagmanager.com/gtag/js?id=UA-119881931-1" async></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date())
gtag('config', 'UA-119881931-1')
</script></head><body><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><a href="https://github.com/topeas"><img src="/images/favicon.jpg"></a></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h1><a>10分钟开启全站https</a></h1></div><div class="post-content"><p>持续了1个多月的备案，今天收到短信终于下来了。</p>
<p>上篇水文，大概的记录了作为前端利用<code>gitlab.com</code>利用gitlab-ci开启CI自动部署。<a href="https://juejin.im/post/5b03963a51882542821ca56a" target="_blank" rel="noopener">前端的gitlab的ci初尝试</a>。这篇文章就要开始记录下我如何开启https。</p>
<h2 id="什么是https？"><a href="#什么是https？" class="headerlink" title="什么是https？"></a>什么是https？</h2><p>https 是什么，不是本文的重点，直接跳过，https 的好处在这里也不仔细讲。</p>
<h2 id="什么是-Let’s-Encrypt？"><a href="#什么是-Let’s-Encrypt？" class="headerlink" title="什么是 Let’s Encrypt？"></a>什么是 Let’s Encrypt？</h2><p>部署 https 网站的时候需要证书，证书由 CA 机构签发，大部分传统 CA 机构签发证书是需要收费的，这不利于推动 https 协议的使用。Let’s Encrypt 也是一个 CA 机构，但这个 CA 机构是免费的！！！也就是说签发证书不需要任何费用。</p>
<h2 id="什么是全站https，也就是通配符证书？"><a href="#什么是全站https，也就是通配符证书？" class="headerlink" title="什么是全站https，也就是通配符证书？"></a>什么是全站https，也就是通配符证书？</h2><p>域名通配符证书类似 DNS 解析的泛域名概念，通配符证书就是证书中可以包含一个通配符。主域名签发的通配符证书可以在所有子域名中使用，比如 .example.com、bbs.example.com、bbs.example.com。
2018 年 3 月 14 日，Let’s Encrypt 对外宣布 ACME v2 已正式支持通配符证书。这就意外味着用户可以在 Let’s Encrypt 上免费申请支持通配符的 SSL 证书。以前配置子域名也是需要每个域名单独的申请证书的，意思是现在可以直接用*.example.com这个证书，让全站实现https。</p>
<p>下面本文就简单的记录了我开启全站https的步骤，10分钟就能搞定，首先从blog子域名开始。</p>
<h2 id="开始配置"><a href="#开始配置" class="headerlink" title="开始配置"></a>开始配置</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 一个顶级域名:peiqixin.com  # 我这里用的是</span><br><span class="line">2. 一台自己的云服务器 # 我这里用的是我的那个小水管，之前在腾讯云撸的羊毛，6年360块钱的服务器，我这里服务器的系统用的是ubuntu</span><br></pre></td></tr></table></figure>
<p>下面的所有操作都是在你的服务器上面，（我的服务器系统是ubuntu 16.04），其他的系统的操作也差不多。</p>
<h3 id="添加一个blog域名解析"><a href="#添加一个blog域名解析" class="headerlink" title="添加一个blog域名解析"></a>添加一个blog域名解析</h3><p><img src="https://user-gold-cdn.xitu.io/2018/5/25/1639657cc55bfa01?w=739&amp;h=402&amp;f=png&amp;s=33712" alt=""></p>
<h3 id="下载Nginx"><a href="#下载Nginx" class="headerlink" title="下载Nginx"></a>下载Nginx</h3><p>安装 nginx 。如果你已经安装可以跳过这步。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nginx</span><br></pre></td></tr></table></figure></p>
<p>如果不会nginx的基本操作和基本配置,建议还是先去了解一下 nginx 的基本配置，比如如何的开启一个web服务器，nginx的基本操作和编写配置（不是必须）。</p>
<h3 id="下载certbot客户端"><a href="#下载certbot客户端" class="headerlink" title="下载certbot客户端"></a>下载certbot客户端</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:certbot/certbot</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python-certbot-nginx</span><br></pre></td></tr></table></figure>
<p>安装的时候一路 enter 就完事儿了。</p>
<h3 id="获取-Let’s-Encrypt-certificate"><a href="#获取-Let’s-Encrypt-certificate" class="headerlink" title="获取 Let’s Encrypt certificate"></a>获取 Let’s Encrypt certificate</h3><p>cerbot 提供 nginx 配置以帮助我们重新配置我们以前的 nginx 配置，以便我们可以使用我们即将获得的 SSL 证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## 我的域名是peiqixin.com。这里要换成你要配置的域名</span><br><span class="line">sudo certbot --server https://acme-v02.api.letsencrypt.org/directory --manual --preferred-challenges dns  --installer nginx -d *.peiqixin.com -d peiqixin.com</span><br></pre></td></tr></table></figure>
<p>然后又是一路的确定选择确定就可以了。</p>
<p>但是请注意这一步，就暂时不要继续enter了</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/5/25/16396584136eeef5?w=605&amp;h=121&amp;f=png&amp;s=16144" alt=""></p>
<p>请把这段token复制下来。
打开你的域名提供商，就是你之前买域名的地方。添加一个域名解析。</p>
<p>记录选择 选择 <code>TXT</code>
主机记录填入 <code>_acme-challenge</code>
记录值就填入刚才你保存下来的token </p>
<p><img src="https://user-gold-cdn.xitu.io/2018/5/25/16396585c5184e2f?w=741&amp;h=398&amp;f=png&amp;s=41943" alt=""></p>
<p>点击保存之后，certbot客户端会去确定你是否在正确的添加了解析。</p>
<p>如果正确的添加了解析。
接下来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Which server blocks would you like to modify?</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1: File: /etc/nginx/sites-enabled/default</span><br><span class="line">Addresses: [::]:80 default_server, 80 default_server</span><br><span class="line">Names: _</span><br><span class="line">HTTPS: No</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Select the appropriate numbers separated by commas and/or spaces, or leave input</span><br><span class="line">blank to select all options shown (Enter &apos;c&apos; to cancel):</span><br></pre></td></tr></table></figure>
<p>将呈现nginx配置中的服务器块列表，供您选择要将证书部署到的服务器块。
反正我用不上，这里选择cancel，输入c，enter继续。</p>
<p>接下来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">1: No redirect - Make no further changes to the webserver configuration.</span><br><span class="line">2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for</span><br><span class="line">new sites, or if you&apos;re confident your site works on HTTPS. You can undo this</span><br><span class="line">change by editing your web server&apos;s configuration.</span><br></pre></td></tr></table></figure>
<p>这一步就是让你选择是否将http流量重定向到建议的https。既然是全站https，所有的访问都应该走https,选择2，enter。提供与前一阶段相同的列表，输入c，按enter继续。</p>
<p>接下来，当你看到下面的一段就表明你已经配置好了。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/5/25/16396587ee0f70eb?w=600&amp;h=274&amp;f=png&amp;s=45607" alt=""></p>
<p>请把
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/letsencrypt/live/peiqixin.com/fullchain.pem</span><br><span class="line">/etc/letsencrypt/live/peiqixin.com/privkey.pem</span><br></pre></td></tr></table></figure></p>
<p>这2个地址记下来</p>
<h3 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure>
<p>找到你的nginx配置文件的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir conf.d #创建一个配置nginx的目录，不可能把所有的配置写在一个文件里面，以后也不好维护</span><br></pre></td></tr></table></figure>
<p>再在nginx的默认配置文件nginx.conf的http模块里面添加
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /etc/nginx/conf.d/*.conf;  #引入所有的配置文件</span><br></pre></td></tr></table></figure></p>
<p>在conf.d文件夹里面创建一个<code>index.conf</code>，创建主配置文件负责监听80端口并转发请求。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name peiqixin.com www.peiqixin.com blog.peiqixin.com;</span><br><span class="line">    rewrite ^(.*) https://$host permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建https配置文件。创建各域名配置文件监听443端口（可以按域名分开，也可以写一个文件里，我为了方便写在一个文件里）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen       443;</span><br><span class="line">       server_name  peiqixin.com  www.peiqixin.com;</span><br><span class="line"></span><br><span class="line">       ssl on;</span><br><span class="line">       ssl_certificate      /etc/letsencrypt/live/peiqixin.com/fullchain.pem; ## 这个就是你配置certbot最后一步要你记录下来的地址</span><br><span class="line">       ssl_certificate_key  /etc/letsencrypt/live/peiqixin.com/privkey.pem;</span><br><span class="line">       </span><br><span class="line">       ssl_session_cache    shared:SSL:10m;</span><br><span class="line">       ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">       ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">       ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">           root /home/ubuntu/blog;  ##这里我用hexo博客生成器生成的静态html，js，css都放在了这个文件</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">server &#123;</span><br><span class="line">       listen       443;</span><br><span class="line">       server_name  blog.peiqixin.com;</span><br><span class="line"></span><br><span class="line">       ssl on;</span><br><span class="line">       ssl_certificate      /etc/letsencrypt/live/peiqixin.com/fullchain.pem;</span><br><span class="line">       ssl_certificate_key  /etc/letsencrypt/live/peiqixin.com/privkey.pem;</span><br><span class="line">       </span><br><span class="line">       ssl_session_cache    shared:SSL:10m;</span><br><span class="line">       ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">       ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">       ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">           root /home/ubuntu/blog;</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>退出保存。检测一下nginx的配置是否有语法错误
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></p>
<p>重启nginx</p>
<h3 id="更新证书"><a href="#更新证书" class="headerlink" title="更新证书"></a>更新证书</h3><p>因为这个https证书是有3个月的期限的，差不多快到快要到3个月的时候，<code>letsencrypt</code>会发邮件给你，告诉你的证书快要过期。这个时候你就可以自己重新安排下证书了。
（你也可以写个定时脚本，但是那个不是本文的关注的地方，而且我也没写）
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">certbot renew</span><br><span class="line">// 上面的指令我跑不成功，就换成下面的这条，等于说是重新的申请下证书，不用改配置，30秒就选择完了</span><br><span class="line">// sudo certbot --force-renew</span><br></pre></td></tr></table></figure></p>
<p>访问<code>blog.peiqixin.com</code>,就会看见</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/5/25/1639658fcc69df18?w=284&amp;h=38&amp;f=png&amp;s=11400" alt="">
再访问<code>peiqixin.com</code></p>
<p><img src="https://user-gold-cdn.xitu.io/2018/5/25/163965945169f0f8?w=246&amp;h=28&amp;f=png&amp;s=5387" alt="">
都是自动的从http跳转到https。</p>
<p>接下来想要添加一个<code>api.peiqixin.com</code>域名为https。重复上面的第一步和最后一步，然后就可以在<code>api.peiqixin.com</code>域名旁边看到小绿锁。</p>
<p>参考资料
1. <a href="https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx" target="_blank" rel="noopener">certbot官网</a>
2. <a href="https://blog.codeship.com/how-to-deploy-wildcard-ssl-certificates-using-lets-encrypt/" target="_blank" rel="noopener">how-to-deploy-wildcard-ssl-certificates-using-lets-encrypt</a>
3. <a href="https://my.oschina.net/mrpei123/blog/1794001" target="_blank" rel="noopener">Nginx 配置多域名 http转https</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-calendar"></i><span class="date">创建时间 2018-05-25 下午 04:03</span><i class="fa fa-calendar-o"></i><span class="date">更新时间 2018-08-08 下午 05:50</span><i class="fa fa-tag"></i><a class="tag" href="/tags/https/" title="https">https </a><a class="tag" href="/tags/ubuntu/" title="ubuntu">ubuntu </a></div></div></div></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>